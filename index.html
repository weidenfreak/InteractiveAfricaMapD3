<!DOCTYPE html>
<meta charset="utf-8">
<body>
  <h1>Ethiopia</h1>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>

  <script>
    var width = 960,
        height = 600;

    var color = d3.scale.quantize()
      .range([
        "rgb(255,255,217)",
        "rgb(237,248,177)",
        "rgb(199,233,180)",
        "rgb(127,205,187)",
        "rgb(65,182,196)",
        "rgb(29,145,192)",
        "rgb(34,94,168)",
        "rgb(12,44,132)"]);

    var projection = d3.geo.albers()
      .center([0, 8.5])
      .rotate([-40.4, 0])
      .parallels([20, 50])
      .scale(2000)
      .translate([width / 2, height / 2]);;

    var path = d3.geo.path()
      .projection(projection);

    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

    d3.csv("ethiopia.csv", function(data) {
      color.domain([0, 100]);

      //d3.json("subunits.json", function(error, ethiopia) {
      //  var subunits = topojson.feature(ethiopia, ethiopia.objects.subunits);
      d3.json("subunits.json", function(json) {
        //var subunits = json.objects.subunits;
        //Merge the ag. data and GeoJSON
        //Loop through once for each ag. data value

        for (var i = 0; i < data.length; i++) {
          //Grab state name
          var dataState = data[i].state;
          //Grab data value, and convert from string to float
          var dataValue = parseFloat(data[i].value);
          //Find the corresponding state inside the GeoJSON
          for (var j = 0; j < json.features.length; j++) {
            var jsonState = json.features[j].properties.NAME;
            if (dataState == jsonState) {
              //Copy the data value into the JSON
              json.features[j].properties.value = dataValue;
              //Stop looking through the JSON
              break;
            }
          }

        }
        svg.selectAll("path")
          .data(json.features)
          .enter()
          .append("path")
          .attr("d", path)
          .style("fill", function(d) {
            //Get data value
            var value = d.properties.value;

            if (value) {
              //If value exists…
              return color(value);
            } else {
              //If value is undefined…
              return "#ccc";
            }
          });

    })
  });

  </script>
  <input type="range" min="1" max="25" value="0" style="width:100%">
</body>
